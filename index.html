import React, { useState, useEffect, useRef } from 'react';
import { 
  Play, Pause, RotateCcw, AlertTriangle, CheckCircle, XCircle, 
  Flame, Wind, ChefHat, Phone, Volume2, Droplets, Zap, Thermometer, FireExtinguisher
} from 'lucide-react';

// --- DỮ LIỆU KỊCH BẢN (Đã thêm 3 câu hỏi mới) ---
const SCENARIOS = [
  {
    id: 1,
    time: 0,
    duration: 4000,
    text: "Giai đoạn 1: Dầu bắt đầu nóng...",
    subtext: "Quan sát kỹ mặt dầu trong chảo.",
    visual: "boiling",
    intensity: 1,
    quiz: null
  },
  {
    id: 2,
    time: 4,
    duration: 0, // Dừng lại hỏi
    text: "CÂU HỎI 1: DẤU HIỆU NGUY HIỂM",
    visual: "boiling",
    subtext: "Bạn nhìn thấy gì?",
    intensity: 1,
    quiz: {
      question: "Dấu hiệu nào cho thấy dầu ăn đang quá nóng và sắp bốc cháy?",
      options: [
        { id: 'A', text: "Dầu sôi lăn tăn.", correct: false, feedback: "Sai. Dầu sôi nhẹ là bình thường khi nấu." },
        { id: 'B', text: "Khói trắng mỏng bốc lên.", correct: false, feedback: "Sai. Đây thường là hơi nước." },
        { id: 'C', text: "Khói đen dày đặc bốc lên nghi ngút.", correct: true, feedback: "Chính xác! Đây là dấu hiệu dầu đã đạt điểm bốc cháy (Flashpoint)." }
      ]
    }
  },
  {
    id: 3,
    time: 5,
    duration: 3000,
    text: "Giai đoạn 2: Xao nhãng!",
    subtext: "Điện thoại reo làm bạn mất tập trung.",
    visual: "distracted",
    intensity: 2,
    quiz: null
  },
  {
    id: 4,
    time: 8,
    duration: 0, // Dừng lại hỏi
    text: "CÂU HỎI 2: XỬ LÝ KHÓI",
    visual: "smoke",
    subtext: "Khói đen dày đặc! Nguy cơ cháy cao.",
    intensity: 3,
    quiz: {
      question: "Thấy khói đen bốc lên từ chảo, hành động ĐÚNG NHẤT là gì?",
      options: [
        { id: 'A', text: "Tắt bếp (ngắt nguồn nhiệt) ngay lập tức.", correct: true, feedback: "Chính xác! Ngắt nhiệt là ưu tiên số 1 để ngăn dầu tiếp tục nóng." },
        { id: 'B', text: "Thổi mạnh vào chảo cho khói bay đi.", correct: false, feedback: "Sai! Thổi cung cấp thêm Oxy, làm lửa dễ bùng phát." },
        { id: 'C', text: "Đổ thêm dầu lạnh vào.", correct: false, feedback: "Nguy hiểm! Dầu nóng có thể bắn ra gây bỏng." }
      ]
    }
  },
  {
    id: 5,
    time: 9,
    duration: 3000,
    text: "LỬA BÙNG PHÁT!",
    visual: "fire_start",
    subtext: "Ngọn lửa bốc lên trong chảo!",
    intensity: 4,
    quiz: null
  },
  {
    id: 6,
    time: 12,
    duration: 0, // Dừng lại hỏi
    text: "CÂU HỎI 3: BÌNH CHỮA CHÁY",
    visual: "fire_start",
    subtext: "Lửa còn nhỏ. Dùng gì để dập?",
    intensity: 4,
    quiz: {
      question: "Loại bình chữa cháy nào phù hợp nhất cho đám cháy dầu mỡ nhà bếp?",
      options: [
        { id: 'A', text: "Bình bột (loại ABC).", correct: false, feedback: "Không tối ưu. Bột có thể làm bắn dầu và không làm mát hiệu quả." },
        { id: 'B', text: "Bình khí CO2.", correct: false, feedback: "Nguy hiểm. Áp lực khí mạnh có thể thổi bay dầu đang cháy ra ngoài." },
        { id: 'C', text: "Bình hóa chất ướt (loại K hoặc F).", correct: true, feedback: "Tuyệt vời! Loại K/F tạo lớp bọt xà phòng ngăn oxy và làm mát dầu." }
      ]
    }
  },
  {
    id: 7,
    time: 13,
    duration: 3000,
    text: "TÌNH HUỐNG NGUY CẤP HƠN!",
    visual: "fire_big",
    subtext: "Lửa cháy to và bạn không có bình cứu hỏa...",
    intensity: 5,
    quiz: null
  },
  {
    id: 8,
    time: 16,
    duration: 0, // Dừng lại hỏi
    text: "CÂU HỎI 4: QUYẾT ĐỊNH SINH TỬ",
    visual: "fire_critical",
    subtext: "Bạn đang cầm một cốc nước...",
    intensity: 5,
    quiz: {
      question: "Có nên tạt CỐC NƯỚC này vào đám cháy không?",
      options: [
        { id: 'A', text: "TẠT NGAY! (Dập lửa)", correct: false, fatal: true, feedback: "THẢM HỌA! Nước hóa hơi gây nổ tung căn bếp (hiện tượng Boilover)." },
        { id: 'B', text: "TUYỆT ĐỐI KHÔNG! (Tìm cách khác)", correct: true, feedback: "Quyết định sáng suốt! Nước và dầu nóng là kẻ thù." }
      ]
    }
  },
  {
    id: 9,
    time: 17,
    duration: 0, // Dừng lại hỏi
    text: "CÂU HỎI 5: DẬP LỬA BẰNG VẬT DỤNG",
    visual: "fire_big",
    subtext: "Chọn vật dụng thay thế:",
    intensity: 5,
    quiz: {
      question: "Dụng cụ nào sau đây có thể dập tắt đám cháy này an toàn?",
      options: [
        { id: 'A', text: "Nắp vung (kim loại).", correct: true, feedback: "Tuyệt vời! Đậy nắp cắt nguồn Oxy, lửa sẽ tự tắt." },
        { id: 'B', text: "Khăn tắm khô.", correct: false, feedback: "Sai. Khăn khô dễ bắt cháy và làm lửa to hơn." },
        { id: 'C', text: "Bê chảo chạy ra ngoài.", correct: false, feedback: "Quá rủi ro. Dễ vấp ngã làm dầu sôi đổ vào người." }
      ]
    }
  },
  {
    id: 10,
    time: 18,
    duration: 0, // Dừng lại hỏi
    text: "CÂU HỎI 6: SAU KHI DẬP LỬA",
    visual: "success",
    subtext: "Lửa đã tắt nhờ đậy nắp vung.",
    intensity: 0,
    quiz: {
      question: "Khi nào thì an toàn để mở nắp vung ra kiểm tra?",
      options: [
        { id: 'A', text: "Mở ngay lập tức để xem lửa tắt chưa.", correct: false, feedback: "Nguy hiểm! Oxy tràn vào có thể làm lửa bùng cháy trở lại." },
        { id: 'B', text: "Chờ ít nhất 10-15 phút cho chảo nguội hẳn.", correct: true, feedback: "Chính xác! Cần thời gian để nhiệt độ dầu giảm xuống dưới điểm bốc cháy." },
        { id: 'C', text: "Hé nắp một chút rồi đóng lại ngay.", correct: false, feedback: "Vẫn nguy hiểm. Oxy có thể lọt vào gây tái cháy." }
      ]
    }
  },
  {
    id: 11,
    time: 20,
    duration: 4000,
    text: "KẾT THÚC MÔ PHỎNG",
    visual: "success",
    subtext: "Bạn đã hoàn thành bài học an toàn.",
    intensity: 0,
    quiz: null
  }
];

// --- HỆ THỐNG HIỆU ỨNG (PARTICLE SYSTEM) ---

const BoilingOil = () => (
  <div className="absolute inset-0 overflow-hidden rounded-b-3xl">
    {[...Array(12)].map((_, i) => (
      <div 
        key={i}
        className="absolute bg-yellow-100 rounded-full opacity-70 animate-[ping_1s_infinite]"
        style={{
          width: Math.random() * 15 + 5 + 'px',
          height: Math.random() * 15 + 5 + 'px',
          left: Math.random() * 80 + 10 + '%',
          top: Math.random() * 60 + 20 + '%',
          animationDelay: Math.random() + 's',
          animationDuration: (0.3 + Math.random()) + 's'
        }}
      />
    ))}
  </div>
);

const VolumetricSmoke = ({ density = 1 }) => (
  <div className="absolute bottom-full left-1/2 -translate-x-1/2 w-60 h-80 pointer-events-none z-0">
    {[...Array(density * 6)].map((_, i) => (
      <div 
        key={i}
        className="absolute rounded-full blur-2xl animate-[float_3s_linear_infinite]"
        style={{
          width: Math.random() * 60 + 40 + 'px',
          height: Math.random() * 60 + 40 + 'px',
          background: i % 3 === 0 ? '#111' : '#333', 
          left: (Math.random() * 100 - 50) + '%',
          bottom: '-40px',
          opacity: 0,
          animationDelay: (i * 0.3) + 's',
        }}
      />
    ))}
  </div>
);

const RealisticFire = ({ scale = 1 }) => (
  <div className="absolute bottom-5 left-1/2 -translate-x-1/2 z-10 filter drop-shadow-[0_0_25px_rgba(255,80,0,0.8)]" style={{ transform: `scale(${scale * 1.5}) translateX(-33%)` }}>
    <div className="relative w-32 h-48">
       <div className="absolute bottom-0 w-full h-full bg-gradient-to-t from-red-600 via-orange-500 to-yellow-300 rounded-[40%_40%_40%_40%] blur-md animate-[pulse_0.15s_infinite] origin-bottom scale-y-125"></div>
       <div className="absolute bottom-4 left-4 w-[80%] h-[80%] bg-gradient-to-t from-orange-300 to-white rounded-[50%] blur-lg animate-[bounce_0.25s_infinite]"></div>
       {[...Array(10)].map((_, i) => (
         <div 
            key={i}
            className="absolute bottom-10 w-2 h-2 bg-yellow-50 rounded-full animate-[ping_0.8s_infinite]"
            style={{
                left: Math.random() * 100 + '%',
                animationDelay: Math.random() * 0.5 + 's',
                animationDuration: (0.4 + Math.random()) + 's'
            }}
         ></div>
       ))}
    </div>
  </div>
);

// --- COMPONENT BẾP & LỬA BẾP ---
const StoveUnit = ({ intensity }) => (
  <div className="absolute bottom-[-50px] left-1/2 -translate-x-1/2 flex flex-col items-center w-full z-0">
      
      {/* 1. NGỌN LỬA DƯỚI ĐÁY NỒI (Xanh/Cam) */}
      <div className="relative w-48 h-16 -mb-5 z-10 flex justify-center items-end gap-1.5 opacity-90">
          {[...Array(14)].map((_, i) => (
              <div 
                  key={i}
                  className={`w-3 rounded-t-full blur-[2px] animate-[pulse_0.1s_infinite] 
                    ${intensity > 3 ? 'bg-orange-500 h-10 shadow-[0_0_10px_orange]' : 'bg-blue-500 h-6 shadow-[0_0_10px_blue]'}
                  `}
                  style={{
                      animationDelay: (Math.random() * 0.5) + 's',
                      height: (intensity > 3 ? Math.random() * 20 + 30 : Math.random() * 8 + 18) + 'px'
                  }}
              ></div>
          ))}
      </div>

      {/* 2. KIỀNG BẾP (Chảo đặt lên đây) */}
      <div className="w-56 h-4 bg-gray-800 rounded-full border-2 border-gray-600 z-10 relative shadow-lg"></div>

      {/* 3. MẶT BẾP (Thân bếp) */}
      <div className="w-96 h-14 bg-gray-900 rounded-lg border-t-4 border-gray-700 mt-[-2px] shadow-2xl relative z-0 flex justify-center">
           <div className="absolute left-10 top-3 w-8 h-8 bg-gray-400 rounded-full shadow-[inset_0_2px_4px_rgba(0,0,0,0.5)] border border-gray-600 flex items-center justify-center transform -rotate-45">
              <div className="w-full h-1.5 bg-black rounded-full"></div>
           </div>
           <div className="absolute right-10 top-3 w-8 h-8 bg-gray-400 rounded-full shadow-[inset_0_2px_4px_rgba(0,0,0,0.5)] border border-gray-600 flex items-center justify-center transform rotate-12">
              <div className="w-full h-1.5 bg-black rounded-full"></div>
           </div>
           <div className="absolute top-4 text-gray-600 font-bold text-[10px] tracking-widest uppercase">Safety Stove</div>
      </div>
  </div>
);

// --- APP CHÍNH ---
export default function KitchenSafetySimFixed() {
  const [isPlaying, setIsPlaying] = useState(false);
  const [currentSceneIndex, setCurrentSceneIndex] = useState(0);
  const [showQuiz, setShowQuiz] = useState(false);
  const [feedback, setFeedback] = useState(null);
  const [gameState, setGameState] = useState('intro');
  const timerRef = useRef(null);

  const currentScene = SCENARIOS[currentSceneIndex];

  useEffect(() => {
    if (isPlaying && gameState === 'playing' && !showQuiz) {
      if (currentScene.duration > 0) {
        timerRef.current = setTimeout(() => handleNextScene(), currentScene.duration);
      } else if (currentScene.quiz) {
        setIsPlaying(false);
        setShowQuiz(true);
      }
    }
    return () => clearTimeout(timerRef.current);
  }, [isPlaying, currentSceneIndex, gameState, showQuiz]);

  const handleNextScene = () => {
    if (currentSceneIndex < SCENARIOS.length - 1) {
      setCurrentSceneIndex(prev => prev + 1);
    } else {
      setGameState('won');
      setIsPlaying(false);
    }
  };

  const handleStart = () => {
    setGameState('playing');
    setCurrentSceneIndex(0);
    setIsPlaying(true);
    setFeedback(null);
    setShowQuiz(false);
  };

  const handleAnswer = (option) => {
    if (option.fatal) {
      setFeedback({ isCorrect: false, message: option.feedback, fatal: true });
      setTimeout(() => setGameState('exploded'), 1500);
    } else {
      setFeedback({ isCorrect: option.correct, message: option.feedback, fatal: false });
    }
  };

  const handleContinue = () => {
    setFeedback(null);
    setShowQuiz(false);
    setIsPlaying(true);
    handleNextScene();
  };

  const handleRetry = () => {
    setFeedback(null);
    setShowQuiz(false);
    setGameState('intro');
    setCurrentSceneIndex(0);
    setIsPlaying(false);
  };

  // --- RENDER VISUALS ---
  const renderVisuals = () => {
    const { visual, intensity } = currentScene;

    if (gameState === 'exploded') {
      return (
        <div className="absolute inset-0 overflow-hidden flex flex-col items-center justify-center z-50 bg-white animate-[flash_0.2s_ease-out_infinite]">
           <div className="absolute inset-0 bg-gradient-to-br from-red-600 via-orange-600 to-black opacity-90 animate-pulse"></div>
           {[...Array(20)].map((_, i) => (
              <div key={i} className="absolute bg-black w-6 h-6 rounded animate-[spin_0.5s_infinite]" 
                   style={{
                      left: '50%', top: '50%',
                      transform: `translate(${Math.random()*600 - 300}px, ${Math.random()*600 - 300}px) rotate(${Math.random()*360}deg)`
                   }}
              ></div>
           ))}
           <div className="relative z-10 text-center animate-[shake_0.5s_infinite]">
              <h1 className="text-9xl font-black text-black mb-4 uppercase drop-shadow-white tracking-tighter">BÙM!!!</h1>
              <div className="bg-black text-white p-8 rounded-2xl border-8 border-red-600 shadow-2xl">
                 <XCircle size={80} className="mx-auto mb-4 text-red-500" />
                 <p className="text-3xl font-black uppercase">SAI LẦM CHẾT NGƯỜI!</p>
                 <p className="text-xl text-gray-300 mt-2">Nước gặp dầu sôi = Nổ hơi nước (Boilover).</p>
              </div>
              <button onClick={handleRetry} className="mt-10 bg-red-600 text-white px-12 py-5 rounded-full font-bold text-2xl hover:scale-110 transition-transform shadow-[0_0_30px_red]">
                 THỬ LẠI
              </button>
           </div>
        </div>
      );
    }

    return (
      <div className="w-full h-full relative overflow-hidden bg-slate-900">
        
        {/* BG Lighting */}
        <div 
          className="absolute inset-0 transition-colors duration-1000 z-0"
          style={{ 
             background: `radial-gradient(circle at 50% 60%, 
                rgba(255, ${180 - intensity*30}, 0, ${0.15 + intensity * 0.15}) 0%, 
                rgba(15, 23, 42, 1) 80%)` 
          }}
        ></div>

        {/* BG Objects */}
        <div className="absolute inset-0 z-0 opacity-30">
           <div className="absolute top-0 left-0 w-1/3 h-64 bg-slate-800 border-r border-slate-700"></div>
           <div className="absolute top-0 right-0 w-1/3 h-64 bg-slate-800 border-l border-slate-700"></div>
        </div>

        {/* === MAIN STAGE: BẾP & CHẢO === */}
        <div className="absolute top-[45%] left-1/2 -translate-x-1/2 -translate-y-1/2 z-10 w-full max-w-lg h-64 flex justify-center items-end">
           
           {/* Chảo (Đè lên bếp) */}
           <div className={`relative w-80 h-32 bg-slate-800 rounded-b-[4rem] border-4 border-slate-600 shadow-2xl flex justify-center overflow-visible transition-transform duration-100 z-20 ${intensity >= 4 ? 'animate-[shake_0.5s_infinite]' : ''}`}>
              
              <div className="absolute -left-32 top-6 w-36 h-6 bg-black rounded-l-full -rotate-6 shadow-xl border-b-2 border-slate-700"></div>
              
              <div className="absolute inset-0 rounded-b-[4rem] overflow-hidden bg-slate-900">
                  <div className={`absolute bottom-0 w-full h-full transition-colors duration-2000 opacity-95
                     ${intensity <= 1 ? 'bg-yellow-500' : intensity <= 3 ? 'bg-orange-700' : 'bg-red-950'}
                  `}></div>
                  {(visual === 'boiling' || intensity > 0) && <BoilingOil />}
              </div>

              {/* Lửa cháy to hơn */}
              {(visual === 'fire_start' || visual === 'fire_big' || visual === 'fire_critical') && (
                  <RealisticFire scale={visual === 'fire_start' ? 1.2 : 2.5} />
              )}

              {(visual === 'smoke' || intensity >= 3) && <VolumetricSmoke density={intensity} />}

              {visual === 'success' && (
                 <div className="absolute -top-8 left-[-10px] w-[108%] h-20 bg-slate-300 rounded-t-full border-b-8 border-slate-500 shadow-2xl z-50 flex justify-center items-start animate-in slide-in-from-top duration-500">
                    <div className="w-14 h-8 bg-black rounded-t-xl mt-[-8px]"></div>
                 </div>
              )}
           </div>

           {/* BẾP LÒ (Có ngọn lửa xanh) */}
           <StoveUnit intensity={intensity} />
        </div>

        {/* Nhân vật */}
        <div className={`absolute top-[25%] right-[2%] transition-transform duration-700 z-20 ${visual === 'distracted' ? 'translate-x-60 opacity-0' : 'translate-x-0'}`}>
           <div className={`flex flex-col items-center transform scale-90 origin-top-right ${intensity >= 3 ? 'animate-[shake_2s_infinite]' : ''}`}>
              <div className="bg-white p-4 rounded-full shadow-lg border-2 border-gray-300 relative z-10">
                 <ChefHat size={56} className="text-slate-800" />
                 {intensity >= 3 && (
                    <div className="absolute -top-4 -right-4 text-blue-400 animate-bounce bg-white rounded-full p-1 shadow-sm">
                       <Droplets size={28} fill="currentColor" />
                    </div>
                 )}
              </div>
              <div className="w-28 h-40 bg-blue-600 rounded-t-[40px] mt-[-10px] shadow-lg flex justify-center relative">
                  {/* Cốc nước (To và rõ hơn) */}
                  {visual === 'fire_big' && (
                     <div className="absolute -left-20 top-12 animate-[pulse_0.5s_infinite] scale-125 origin-right">
                        <div className="bg-blue-200/90 backdrop-blur w-14 h-20 rounded-b-xl border-x-4 border-b-4 border-white shadow-[0_0_20px_blue] overflow-hidden relative">
                           <div className="absolute bottom-0 w-full h-[85%] bg-blue-500/80 animate-[wave_1s_infinite]"></div>
                           <div className="absolute top-0 w-full h-full bg-white/20"></div>
                        </div>
                        <div className="bg-red-600 text-white text-[10px] font-black px-2 py-1 rounded absolute -top-3 -left-2 animate-bounce">CẤM!</div>
                     </div>
                  )}
              </div>
           </div>
        </div>

        {/* UI OVERLAY */}
        <div className="absolute top-4 right-4 bg-black/70 backdrop-blur-md p-3 rounded-xl border border-white/20 flex items-center gap-3 z-40 shadow-lg">
           <Thermometer size={24} className={intensity >= 4 ? "text-red-500 animate-pulse" : "text-green-500"} />
           <div className="flex flex-col gap-1">
               <span className="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Nhiệt độ dầu</span>
               <div className="w-32 h-3 bg-gray-800 rounded-full overflow-hidden border border-gray-700">
                  <div 
                    className={`h-full transition-all duration-1000 ${intensity >= 4 ? 'bg-gradient-to-r from-orange-500 to-red-600' : intensity >= 2 ? 'bg-orange-500' : 'bg-green-500'}`}
                    style={{ width: `${intensity * 20}%` }}
                  ></div>
               </div>
           </div>
           <span className="text-sm text-white font-mono font-bold">{100 + intensity * 60}°C</span>
        </div>

        <div className="absolute bottom-0 w-full z-40">
           <div className="h-32 bg-gradient-to-t from-black via-black/90 to-transparent absolute bottom-0 w-full pointer-events-none"></div>
           <div className="relative pb-6 px-4 text-center">
               <div className="inline-block animate-in slide-in-from-bottom duration-300">
                  <h3 className="text-orange-500 font-black text-xs uppercase tracking-[0.2em] mb-1 drop-shadow-md bg-black/50 px-2 rounded inline-block">
                    {currentScene.text}
                  </h3>
                  <p className="text-white text-2xl font-medium drop-shadow-lg leading-relaxed max-w-2xl mx-auto">
                    {currentScene.subtext}
                  </p>
               </div>
           </div>
        </div>

      </div>
    );
  };

  return (
    <div className="max-w-5xl mx-auto p-4 font-sans bg-slate-100 min-h-screen">
      {gameState === 'intro' && (
         <div className="absolute inset-0 z-50 bg-black flex flex-col items-center justify-center">
             <div className="relative z-10 text-center">
                 <div className="inline-block p-8 rounded-full bg-gradient-to-br from-orange-500 to-red-600 mb-8 shadow-[0_0_60px_orange] animate-bounce">
                    <Flame size={80} className="text-white" fill="white" />
                 </div>
                 <h1 className="text-7xl font-black text-white mb-4 tracking-tighter">AN TOÀN BẾP</h1>
                 <button onClick={handleStart} className="bg-white text-black px-16 py-6 rounded-full font-black text-2xl hover:bg-orange-500 hover:text-white transition-all transform hover:scale-105 shadow-[0_0_30px_white] flex items-center gap-4 mx-auto mt-8">
                    <Play fill="currentColor" size={32} /> BẮT ĐẦU
                 </button>
             </div>
         </div>
      )}

      {gameState !== 'intro' && (
        <div className="relative aspect-video w-full bg-black rounded-3xl overflow-hidden shadow-2xl border-8 border-slate-900 ring-1 ring-slate-800 my-4">
           {renderVisuals()}

           {showQuiz && !feedback && (
             <div className="absolute inset-0 z-50 bg-black/60 backdrop-blur-md flex items-end justify-center p-0 pb-6">
                <div className="bg-white rounded-t-3xl w-full max-w-3xl shadow-2xl animate-in slide-in-from-bottom duration-300 border-t-4 border-orange-500">
                   <div className="bg-orange-600 p-4 text-white flex items-center gap-4 rounded-t-2xl">
                      <div className="bg-white/20 p-2 rounded-xl animate-pulse">
                        {currentScene.quiz.question.includes("BÌNH CHỮA CHÁY") ? <FireExtinguisher size={28} /> : <AlertTriangle size={28} />}
                      </div>
                      <div>
                         <h3 className="font-black text-xl uppercase tracking-tight">{currentScene.text}</h3>
                      </div>
                   </div>
                   <div className="p-6 bg-slate-50">
                      <p className="text-xl font-bold text-slate-900 mb-6 leading-snug">{currentScene.quiz.question}</p>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                         {currentScene.quiz.options.map((opt) => (
                           <button 
                             key={opt.id} 
                             onClick={() => handleAnswer(opt)}
                             className="text-left p-4 rounded-2xl border-2 border-slate-200 bg-white hover:border-orange-500 hover:bg-orange-50 transition-all shadow-sm hover:shadow-md group flex flex-col h-full justify-center"
                           >
                             <span className="font-black text-orange-500 text-lg block mb-2">{opt.id}</span>
                             <span className="text-base font-bold text-slate-700 group-hover:text-black">{opt.text}</span>
                           </button>
                         ))}
                      </div>
                   </div>
                </div>
             </div>
           )}

           {feedback && (
              <div className="absolute inset-0 z-50 bg-slate-900/95 flex items-center justify-center p-6">
                 <div className={`bg-white rounded-3xl w-full max-w-md p-8 text-center shadow-2xl border-b-8 ${feedback.isCorrect ? 'border-green-500' : 'border-red-500'}`}>
                    <div className="mb-6 flex justify-center">
                       {feedback.isCorrect ? 
                          <div className="bg-green-100 p-6 rounded-full animate-[bounce_1s_infinite]"><CheckCircle size={80} className="text-green-600" /></div> : 
                          <div className="bg-red-100 p-6 rounded-full animate-shake"><XCircle size={80} className="text-red-600" /></div>
                       }
                    </div>
                    <h3 className={`text-4xl font-black mb-4 ${feedback.isCorrect ? 'text-green-700' : 'text-red-700'}`}>
                       {feedback.isCorrect ? 'CHÍNH XÁC' : 'SAI RỒI'}
                    </h3>
                    <p className="text-slate-600 text-xl mb-8 font-medium">{feedback.message}</p>
                    
                    {!feedback.fatal ? (
                       <button onClick={handleContinue} className="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-5 rounded-2xl text-xl transition-colors shadow-lg">TIẾP TỤC</button>
                    ) : (
                       <div className="flex items-center justify-center gap-2 text-red-600 font-black animate-pulse text-2xl uppercase">
                          <Zap size={32} fill="currentColor" /> Kích hoạt nổ...
                       </div>
                    )}
                 </div>
              </div>
           )}
           
           <div className="absolute bottom-4 left-4 z-50">
              <button onClick={() => setIsPlaying(!isPlaying)} className="text-white/50 hover:text-white transition-colors bg-white/10 p-2 rounded-full backdrop-blur">
                  {isPlaying ? <Pause size={20} fill="currentColor"/> : <Play size={20} fill="currentColor"/>}
              </button>
           </div>
        </div>
      )}
      <style>{`
        @keyframes float { 0% { transform: translateY(0) scale(1); opacity: 0; } 20% { opacity: 0.6; } 100% { transform: translateY(-80px) scale(2); opacity: 0; } }
        @keyframes wave { 0% { transform: translateX(-5%); } 50% { transform: translateX(5%); } 100% { transform: translateX(-5%); } }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-2px) rotate(-1deg); } 75% { transform: translateX(2px) rotate(1deg); } }
      `}</style>
    </div>
  );
}